---
# ========================================================
# üê≥ Install Docker Engine + Compose v2 via Shell (Ubuntu 24.04)
# ========================================================

- name: Remove old Docker versions if present
  become: yes
  ansible.builtin.shell: |
    apt-get remove -y docker docker-engine docker.io containerd runc || true
  ignore_errors: yes

# ========================================================
# Install prerequisites
# ========================================================
- name: Install required dependencies
  become: yes
  ansible.builtin.shell: |
    apt-get update -y
    apt-get install -y ca-certificates curl gnupg lsb-release apt-transport-https software-properties-common

# ========================================================
# Add Docker‚Äôs official GPG key and repository
# ========================================================
- name: Create directory for Docker keyrings
  become: yes
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: Add Docker GPG key
  become: yes
  ansible.builtin.shell: |
    if [ ! -f /etc/apt/keyrings/docker.gpg ]; then
      curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
      chmod a+r /etc/apt/keyrings/docker.gpg
    fi

- name: Add Docker repository for Ubuntu 24.04 (noble)
  become: yes
  ansible.builtin.shell: |
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
    https://download.docker.com/linux/ubuntu noble stable" > /etc/apt/sources.list.d/docker.list

- name: Update apt cache
  become: yes
  ansible.builtin.shell: apt-get update -y

# ========================================================
# Install Docker CE + Compose Plugin
# ========================================================
- name: Install Docker CE and Compose plugin
  become: yes
  ansible.builtin.shell: |
    apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  register: docker_install
  ignore_errors: yes

# ========================================================
# Fallback if Docker CE not available
# ========================================================
- name: Fallback install docker.io
  become: yes
  ansible.builtin.shell: apt-get install -y docker.io
  when: docker_install.rc != 0

# ========================================================
# Manually install Docker Compose v2 binary (guaranteed)
# ========================================================
- name: Ensure Docker Compose v2 binary installed
  become: yes
  ansible.builtin.shell: |
    mkdir -p /usr/local/lib/docker/cli-plugins
    curl -SL https://github.com/docker/compose/releases/download/v2.27.1/docker-compose-linux-x86_64 \
      -o /usr/local/lib/docker/cli-plugins/docker-compose
    chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
  args:
    creates: /usr/local/lib/docker/cli-plugins/docker-compose

# ========================================================
# Verify Docker installation
# ========================================================
- name: Verify Docker and Compose installation
  become: yes
  ansible.builtin.shell: |
    docker --version && docker compose version
  register: docker_check

- name: Show installed versions
  ansible.builtin.debug:
    msg: "{{ docker_check.stdout_lines }}"

# ========================================================
# Enable & start Docker service (safe systemd)
# ========================================================
- name: Ensure Docker service is enabled and running
  become: yes
  ansible.builtin.systemd:
    name: docker
    enabled: true
    state: started
  register: docker_service_status
  ignore_errors: yes

- name: Debug Docker service status
  ansible.builtin.debug:
    msg: "Docker service status: {{ docker_service_status }}"

# ========================================================
# Ensure Docker Compose Project Directory
# ========================================================
- name: Define default project path
  set_fact:
    compose_project_path: "{{ compose_project_path | default('/opt/myapp') }}"

- name: Ensure project directory exists
  become: yes
  ansible.builtin.file:
    path: "{{ compose_project_path }}"
    state: directory
    mode: '0755'

- name: Check project directory status
  become: yes
  ansible.builtin.stat:
    path: "{{ compose_project_path }}"
  register: project_dir_check

- name: Fail if project directory was not created
  ansible.builtin.fail:
    msg: "‚ùå Project directory {{ compose_project_path }} not found even after creation attempt!"
  when: not project_dir_check.stat.exists

# ========================================================
# Template docker-compose.yaml dynamically
# ========================================================
- name: Template docker-compose.yaml
  become: yes
  ansible.builtin.template:
    src: docker-compose.yaml.j2
    dest: "{{ compose_project_path }}/docker-compose.yaml"
    mode: '0644'

# ========================================================
# Deploy application with Docker Compose v2
# ========================================================
- name: Deploy application using Docker Compose v2
  become: yes
  ansible.builtin.shell: |
    docker compose -f "{{ compose_project_path }}/docker-compose.yaml" up -d
  args:
    chdir: "{{ compose_project_path }}"
  register: compose_output
  ignore_errors: no

- name: Debug deployment output
  ansible.builtin.debug:
    var: compose_output.stdout_lines
